<div class="song-list-container">
  <h2>Songs</h2>

  <div *ngIf="loading" data-testid="loading-indicator">Loading...</div>

  <div *ngIf="error" class="error-message" data-testid="error-message">
    {{ error }}
  </div>

  <div class="carousel-container" *ngIf="!loading && !error">
    <div class="carousel-wrapper" #carouselWrapper (mouseenter)="pauseAutoScroll()" (mouseleave)="resumeAutoScroll()">
      <div class="song-carousel" #songCarousel>
        <!-- Elementos duplicados al inicio para el efecto infinito -->
        <div *ngFor="let song of clonedSongsEnd" class="song-card clone" data-testid="song-item-clone">
          <div class="song-poster">
            <img [src]="song.poster || 'assets/default-artist.png'" [alt]="song.title">
          </div>
          <div class="song-title">{{ song.title }}</div>
          <div class="song-details">
            <span>Year: {{ song.year }}</span>
            <span>Rating: {{ song.rating }}</span>
            <span>Duration: {{ song.duration }} seconds</span>
          </div>
          <!-- Para los elementos clonados al inicio -->
          <div class="song-genres">
            <ng-container *ngFor="let genre of song.genre.slice(0, 2); let i = index">
              <span class="genre-tag">{{ genre }}</span>
            </ng-container>
            <span *ngIf="song.genre.length > 2" class="genre-tag more-tag">+{{ song.genre.length - 2 }}</span>
          </div>
          <div class="song-actions">
            <button class="info-btn" (click)="openInfoModal(song)">Info</button>
            <button class="edit-btn" (click)="openEditModal(song)">Edit</button>
            <button class="delete-btn" (click)="deleteSong(song.id)">Delete</button>
          </div>
        </div>

        <!-- Elementos originales -->
        <div *ngFor="let song of songs" class="song-card" data-testid="song-item">
          <div class="song-poster">
            <img [src]="song.poster || 'assets/default-artist.png'" [alt]="song.title">
          </div>
          <div class="song-title">{{ song.title }}</div>
          <div class="song-details">
            <span>Year: {{ song.year }}</span>
            <span>Rating: {{ song.rating }}</span>
            <span>Duration: {{ song.duration }} seconds</span>
          </div>
          <!-- Para los elementos originales -->
          <div class="song-genres">
            <ng-container *ngFor="let genre of song.genre.slice(0, 2); let i = index">
              <span class="genre-tag">{{ genre }}</span>
            </ng-container>
            <span *ngIf="song.genre.length > 2" class="genre-tag more-tag">+{{ song.genre.length - 2 }}</span>
          </div>
          <div class="song-actions">
            <button class="info-btn" (click)="openInfoModal(song)">Info</button>
            <button class="edit-btn" (click)="openEditModal(song)">Edit</button>
            <button class="delete-btn" (click)="deleteSong(song.id)">Delete</button>
          </div>
        </div>

        <!-- Elementos duplicados al final para el efecto infinito -->
        <div *ngFor="let song of clonedSongsStart" class="song-card clone" data-testid="song-item-clone">
          <div class="song-poster">
            <img [src]="song.poster || 'assets/default-artist.png'" [alt]="song.title">
          </div>
          <div class="song-title">{{ song.title }}</div>
          <div class="song-details">
            <span>Year: {{ song.year }}</span>
            <span>Rating: {{ song.rating }}</span>
            <span>Duration: {{ song.duration }} seconds</span>
          </div>
          <!-- Para los elementos clonados al final -->
          <div class="song-genres">
            <ng-container *ngFor="let genre of song.genre.slice(0, 2); let i = index">
              <span class="genre-tag">{{ genre }}</span>
            </ng-container>
            <span *ngIf="song.genre.length > 2" class="genre-tag more-tag">+{{ song.genre.length - 2 }}</span>
          </div>
          <div class="song-actions">
            <button class="info-btn" (click)="openInfoModal(song)">Info</button>
            <button class="edit-btn" (click)="openEditModal(song)">Edit</button>
            <button class="delete-btn" (click)="deleteSong(song.id)">Delete</button>
          </div>
        </div>
      </div>
    </div>
    <div class="carousel-controls">
      <button class="control-btn prev" (click)="scrollCarousel(-1)" aria-label="Previous">❮</button>
      <button class="control-btn next" (click)="scrollCarousel(1)" aria-label="Next">❯</button>
    </div>
  </div>
</div>

<!-- Modal de edición -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeModal($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>Edit Song</h3>
    <form [formGroup]="songForm" (ngSubmit)="saveSong()">
      <div class="form-group">
        <label for="title">Title</label>
        <input type="text" id="title" formControlName="title">
        <div class="error-message" *ngIf="songForm.get('title')?.invalid && songForm.get('title')?.touched">
          Title is required
        </div>
      </div>

      <div class="form-group">
        <label for="year">Year</label>
        <input type="number" id="year" formControlName="year">
        <div class="error-message" *ngIf="songForm.get('year')?.invalid && songForm.get('year')?.touched">
          Valid year is required
        </div>
      </div>

      <div class="form-group">
        <label for="duration">Duration (seconds)</label>
        <input type="number" id="duration" formControlName="duration">
        <div class="error-message" *ngIf="songForm.get('duration')?.invalid && songForm.get('duration')?.touched">
          Valid duration is required
        </div>
      </div>

      <div class="form-group">
        <label for="rating">Rating</label>
        <input type="number" id="rating" formControlName="rating" step="0.01" min="0" max="10">
        <div class="error-message" *ngIf="songForm.get('rating')?.invalid && songForm.get('rating')?.touched">
          Rating must be between 0 and 10
        </div>
      </div>

      <div class="form-group">
        <label for="poster">Poster URL</label>
        <input type="text" id="poster" formControlName="poster">
      </div>

      <div class="form-group">
        <label>Genres</label>
        <div class="genres-container">
          <div *ngFor="let genre of availableGenres; let i = index" class="genre-checkbox">
            <input type="checkbox" [id]="'genre-' + i" [value]="genre" (change)="onGenreChange($event)"
              [checked]="selectedGenres.includes(genre)">
            <label [for]="'genre-' + i">{{ genre }}</label>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="closeModal()">Cancel</button>
        <button type="submit" class="save-btn" [disabled]="songForm.invalid">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de confirmación -->
<!-- Modal de confirmación de eliminación -->
<div class="modal-overlay" *ngIf="showDeleteConfirmModal">
  <div class="modal-content confirm-modal">
    <h3>Confirm Deletion</h3>
    <p>Are you sure you want to delete this song?</p>
    <div class="form-actions">
      <button type="button" class="cancel-btn" (click)="cancelDelete()">Cancel</button>
      <button type="button" class="delete-confirm-btn" (click)="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- Modal de éxito para eliminación -->
<div class="modal-overlay" *ngIf="showDeleteSuccessModal">
  <div class="modal-content success-modal">
    <div class="success-icon">✓</div>
    <h3>Success!</h3>
    <p>The song has been deleted successfully.</p>
    <div class="form-actions">
      <button class="success-btn" (click)="reloadPage()">Accept</button>
    </div>
  </div>
</div>

<!-- Modal de confirmación de edición (ya existente) -->
<div class="modal-overlay" *ngIf="showSuccessModal">
  <div class="modal-content success-modal">
    <div class="success-icon">✓</div>
    <h3>Success!</h3>
    <p>The song has been updated successfully.</p>
    <div class="form-actions">
      <button class="success-btn" (click)="reloadPage()">Accept</button>
    </div>
  </div>
</div>

<!-- Modal de información detallada -->
<div class="modal-overlay" *ngIf="showInfoModal">
  <div class="modal-content info-modal" (click)="$event.stopPropagation()">
    <h3 *ngIf="selectedSong">{{ selectedSong.title }}</h3>
    <div class="info-content" *ngIf="selectedSong" style="text-align: center; margin-bottom: 20px; color: #2196f3; font-weight: 700; font-size: 1.5em;">
    </div>
    <div class="info-content" *ngIf="selectedSong">

      <div class="info-poster">
        <img [src]="selectedSong.poster || 'assets/default-artist.png'" [alt]="selectedSong.title">
      </div>

      <div class="info-details">
        <div class="info-row">
          <span class="info-label">Year:</span>
          <span class="info-value">{{ selectedSong.year }}</span>
        </div>

        <div class="info-row">
          <span class="info-label">Rating:</span>
          <span class="info-value">{{ selectedSong.rating }} / 10</span>
        </div>

        <div class="info-row">
          <span class="info-label">Duration:</span>
          <span class="info-value">{{ selectedSong.duration }} seconds ({{ formatDuration(selectedSong.duration)
            }})</span>
        </div>

        <div class="info-row">
          <span class="info-label">Genres:</span>
          <div class="info-genres">
            <span *ngFor="let genre of selectedSong.genre" class="genre-tag">{{ genre }}</span>
          </div>
        </div>

        <div class="info-row" *ngIf="selectedSong.artist">
          <span class="info-label">Artist:</span>
          <div *ngIf="selectedArtist; else loadingArtist" class="artist-info">
            <div class="artist-name">{{ selectedArtist.name }}</div>
            <div class="artist-details">
              <span>Country: {{ selectedArtist.bornCity }}</span>
              <span *ngIf="selectedArtist.birthdate">Birthdate: {{ selectedArtist.birthdate | date }}</span>
            </div>
          </div>
          <ng-template #loadingArtist>
            <span class="info-value">Loading artist information...</span>
          </ng-template>
        </div>
      </div>
    </div>
    <div class="form-actions">
      <button class="close-btn" (click)="closeInfoModal()">Close</button>
    </div>
  </div>
</div>